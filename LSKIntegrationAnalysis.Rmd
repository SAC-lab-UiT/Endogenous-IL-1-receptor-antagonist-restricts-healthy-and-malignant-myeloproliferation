---
title: "LSK Analysis"
output: html_notebook
---

```{r}
suppressWarnings(library(Seurat))
suppressWarnings(library(tidyverse))
suppressWarnings(library(RColorBrewer))
suppressWarnings(library(openxlsx))
suppressWarnings(library(circlize))
suppressWarnings(library(gtools))
suppressWarnings(library(ggExtra))
suppressWarnings(library(patchwork))

projectDir <- "."
projectPath <- file.path(projectDir)
outputPath <- file.path(projectPath)
dataDir <- "data"
dataPath <- file.path(projectPath,dataDir)
prefix <- "LSK"

dir.create(file.path(outputPath),recursive = T)

setwd(outputPath)

color.list <- c("#ebac23", "#b80058", "#008cf9",
                "#006e00", "#00bbad", "#d163e6",
                "#b24502", "#ff9287", "#5954d6",
                "#00c6f8", "#878500", "#00a76c",
                "#bdbdbd", "#846b54",
                brewer.pal(12, "Paired"),
                brewer.pal(12, "Set3"),
                brewer.pal(8, "Pastel2"),
                colorRampPalette(c("grey20","grey70"))(4))
```

# Load Counts

```{r}
sc <- Read10X(file.path(dataPath,"lsk.counts"))
sc <- CreateSeuratObject(
  counts = sc,
  assay = "RNA",
  project = "LSK",
  names.field = c(1,2),
  names.delim = "_",
  min.cells = 0,
  min.features = 0
)
sc@meta.data$SampleName <- sc@meta.data$orig.ident

table(sc$SampleName)
```

# Integration by Sample using CCA

```{r}
cellSet <- "LSK"
subsetName <- "Integrated"
```

```{r}
nfeatures <- 2000
ress <- c(0.5)
npcs <- 15

bySample <- SplitObject(sc, split.by = "SampleName")

# Integration via CCA protocol
bySample <- lapply(bySample, function (x) {
  x <- x %>% NormalizeData(verbose=F) %>%
    FindVariableFeatures(nfeatures = nfeatures,
                         verbose=F) %>%
    ScaleData(verbose=F) %>%
    RunPCA(verbose=F)
  return(x)
})

commonFeatures <- SelectIntegrationFeatures(bySample,
                                            verbose=F)

smanchors <- FindIntegrationAnchors(bySample,
                                    anchor.features = commonFeatures,
                                    dims = seq(npcs),
                                    verbose=F)

bySample.cca <- IntegrateData(anchorset = smanchors,
                              dims = seq(npcs),
                              features.to.integrate = rownames(bySample[[1]]),
                              verbose=F)

DefaultAssay(bySample.cca) <- "integrated"

# Run the standard workflow for clustering and visualization of integrated data
bySample.cca <- bySample.cca %>%
  ScaleData(verbose = FALSE) %>%
  RunPCA(verbose = FALSE) %>%
  FindNeighbors(reduction = "pca",
                dims = seq(npcs),
                force.recalc = T,
                verbose=F) %>%
  FindClusters(resolution = ress,
               verbose=F) %>%
  RunUMAP(reduction = "pca",
          dims = seq(npcs),
          verbose=F) %>%
  RunTSNE(reduction = "pca",
          dims = seq(npcs),
          perplexity=100,
          verbose=F)

# Reannotate clusters
bySample.cca@meta.data <- bySample.cca@meta.data %>%
  mutate(across(starts_with("integrated_"),.fns = function (x){paste0("C",x)})) %>%
  mutate(across(starts_with("integrated_"),.fns = function (x){factor(x)})) %>%
  mutate(across(starts_with("integrated_"),.fns = function (x){factor(x,levels=mixedsort(levels(x)))}))

DefaultAssay(bySample.cca) <- "RNA"

saveRDS(bySample.cca,file = file.path(outputPath,paste(cellSet,subsetName,"seurat","rds",sep = ".")))

bySample.cca
```

```{r}
clustering <- "integrated_snn_res.0.5"
```

```{r}
p1 <- DimPlot(bySample.cca,
              reduction = "tsne",
              group.by = "SampleName",
              cols = color.list)
p2 <- DimPlot(bySample.cca,
              reduction = "tsne",
              group.by = clustering,
              cols = color.list)
p1 + p2
```

```{r}
DimPlot(bySample.cca,
        reduction = "tsne",
        group.by = clustering,
        cols = color.list,
        split.by = "SampleName")
```

## Sommerkamp Cell Type Module Scores

Cell Type modules are obtained from the paper [Sommerkamp et. al. Blood 2021.](https://doi.org/10.1182/blood.2020007876)

[bloodbld2020007876-suppl2.xlsx](
https://ash.silverchair-cdn.com/ash/content_public/journal/blood/137/23/10.1182_blood.2020007876/5/bloodbld2020007876-suppl2.xlsx?Expires=1672939940&Signature=I~n~3G8T3hfbaJiT9HDLN3DnjK7NGvp27c7x1UudMesKskIgi9YhVZdA4FQ0qsAMTyPe8VLAvGIKaRHjCO0lDBTRiBXED2smhOITE3sN2~N4BXRW-O2xRQFH9iIW0rzYTePZhHVwtMuM9i~RQU-b16Oh5I~sohG8QcgxfYapMOlOwRfIanqyEHPPtTQt0S439uMi6mJlkT8w91-cIejwotA3eH7nJSoAA~hQc8H0pywp8Qmi164xkoZqT4247j3fqJwuNa4rRRS9mpskVvWN3mGEXmqykbHeWFMZ~HjOzzIVI07VmePy1ruvM1lWnp3v9i5XJIFOjAG16X0PSIl92g__&Key-Pair-Id=APKAIE5G5CRDK6RD3PGA)

```{r}
modules <- data.frame(CellType=c("HSC","MPP1","MPP2","MPP3","MPP4","MPP5"),sheet = seq(6))
modulesList <- list()
for (i in modules$sheet) {
  modulesList[[modules$CellType[i]]] <- read.xlsx(file.path(dataPath,"bloodbld2020007876-suppl2.xlsx"),
                                                  sheet = i,
                                                  colNames = T)  
}
```

```{r}
# Filter modules to genes present in our experiment
moduleGenesList <- list()
for (i in modules$sheet) {
  moduleGenesList[[i]] <- intersect(modulesList[[i]]$GeneSymbol,rownames(bySample.cca))
}
names(moduleGenesList) <- modules$CellType

# Compute Module enrichment score
for (i in modules$sheet) {
  bySample.cca <- AddModuleScore(bySample.cca
                             ,features = moduleGenesList[i]
                             ,name =  paste0(modules$CellType[i],".RNAModule")
                             ,assay = "RNA"
                             )
}
```

```{r}
df <- Embeddings(bySample.cca,reduction = "tsne")
dims <- colnames(df)
df <- cbind(df,bySample.cca@meta.data %>% dplyr::select(contains(".RNAModule1")))
```

### Cell Type Scores Plots

```{r}
df %>%
  pivot_longer(cols = contains("RNAModule1"), names_to = "Module", values_to = "Score") %>%
  mutate(Module=sub(".RNAModule1","",Module)) %>%
  ggplot(aes_string(x=dims[1],y=dims[2],color="Score")) +
  geom_point() +
  scale_color_gradientn(colors = colorRampPalette(c("grey","orange","red"))(3),name="Log(NormCounts)") +
  facet_wrap("Module") +
  theme_classic()
```

### Module Asingments to Clusters

Cluster assigned to the maximum enrichment module score +- 0.02. Some clusters may score two modules or more as maximum.

Analysis based on WT transcriptome only.

```{r message=FALSE, warning=FALSE}
clustering <- "integrated_snn_res.0.5"
bySample.cca@meta.data %>%
  filter(SampleName == "LSK_WT") %>%
  dplyr::select(contains(c(clustering,"RNAModule1"))) %>%
  pivot_longer(cols = contains("RNAModule1"),names_to = "Module",values_to = "Score") %>%
  rename(Cluster=clustering) %>%
  group_by(Module) %>%
  summarise(Score=scale(Score,center = T,scale = T),Cluster=Cluster) %>%
  group_by(Cluster,Module) %>%
  summarise(AverageScore=mean(Score)) %>%
  group_by(Cluster) %>%
  summarise(Module=Module,AverageScoreScaled=scale(AverageScore),MaxEnrichment=(AverageScore >= (max(AverageScore)-0.02))) %>%
  mutate(Module=sub(".RNAModule1","",Module)) %>%
  mutate(plotBorder=ifelse(MaxEnrichment,1.5,0)) %>%
  ggplot() +
  geom_point(aes_string(x="Module",y="Cluster",fill="AverageScoreScaled",color="MaxEnrichment", stroke = "plotBorder"),size=6,shape=21) +
  scale_fill_gradient(low = "grey90",high = "blue") +
  scale_color_manual(values = c(NA,"red"))
```

```{r message=FALSE, warning=FALSE}
# Assign Sommerkamp cell type to clusters using WT info
cellTypeAnnot <- bySample.cca@meta.data %>%
  filter(SampleName == "LSK_WT") %>%
  dplyr::select(contains(c(clustering,"RNAModule1"))) %>%
  pivot_longer(cols = contains("RNAModule1"),names_to = "Module",values_to = "Score") %>%
  rename(Cluster=clustering) %>%
  group_by(Module) %>%
  summarise(Score=scale(Score,center = T,scale = T),Cluster=Cluster) %>%
  group_by(Cluster,Module) %>%
  summarise(AverageScore=mean(Score)) %>%
  group_by(Cluster) %>%
  summarise(Module=Module,AverageScoreScaled=scale(AverageScore),MaxEnrichment=(AverageScore >= (max(AverageScore)-0.02))) %>%
  mutate(Module=sub(".RNAModule1","",Module)) %>%
  mutate(Selected=ifelse(MaxEnrichment,1,0)) %>%
  filter(Selected == 1) %>%
  group_by(Cluster) %>%
  summarise(CellType1 = paste(Module,collapse="_"))
```

Cluster 4 has been modified manually after exploring the scores, HSC and MPP1 scores were very similar and not very high. Also evaluating the genes manualy led us to assign Cluster 4 to MPP1 and HSC.

```{r}
# Manualy upadte MPP1 characterization
cellTypeAnnot <- cellTypeAnnot %>%
  mutate(CellType1 = case_when(
    CellType1 == "MPP1" ~ "HSC_MPP1",
    TRUE ~ CellType1
  ))
```

```{r}
bySample.cca@meta.data <- bySample.cca@meta.data %>%
  left_join(cellTypeAnnot, by = c("integrated_snn_res.0.5" = "Cluster")) %>% as.data.frame()
rownames(bySample.cca@meta.data) = colnames(bySample.cca)
```

### Cell Type By Cluster

```{r}
p1 <- DimPlot(bySample.cca,
              reduction = "tsne",
              group.by = clustering,
              cols = color.list,
              label = T) + theme(legend.position = "none")
p2 <- DimPlot(bySample.cca,
              reduction = "tsne",
              group.by = "CellType1", 
              cols = color.list,
              label = F)
p1 + p2
```

### Cell Type By Condition

```{r}
DimPlot(bySample.cca,
        reduction = "tsne",
        group.by = "CellType1",
        cols = color.list,
        split.by = "SampleName")
```


### Cell Type Proportions

```{r}
bySample.cca@meta.data %>%
  ggplot(aes(x="",fill=CellType1)) +
  geom_bar(stat="count",position="fill") +
  coord_polar("y",start = 0) +
  scale_fill_manual(values = color.list) +
  facet_wrap("SampleName") +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank())
```

```{r}
bySample.cca@meta.data %>%
  group_by(SampleName) %>%
  count(
    CellType1
  ) %>%
  pivot_wider(id_cols = SampleName, names_from = CellType1, values_from = n)
```

## Marker Genes for each cell type

Based on WT transcriptomes.

```{r}
clustering <- "CellType1"

Idents(bySample.cca) <- clustering

minPct <- 30
pval <- 0.01
useAssay <- "RNA"
method <- "wilcox"

bySample.cca.WT <- subset(bySample.cca, SampleName == "LSK_WT")
```

```{r }
markers <- bySample.cca.WT %>%
  FindAllMarkers(
    assay = useAssay
    , slot = "data"
    , min.pct = minPct/100
    , return.thresh = pval
    , test.use = method
    , verbose = F
    , only.pos = T
  )
```

```{r }
markers %>%
  filter(p_val_adj < pval) %>%
  group_by(cluster) %>%
  count()
```

### Top 30 Markers Heatmap

```{r fig.asp=1.3}
ntop <- 30

topMarkers <- markers %>% 
  filter(p_val_adj < pval) %>%
  group_by(cluster) %>%
  top_n(ntop, avg_log2FC)

bySample.cca %>%
  DoHeatmap(assay = "integrated",
            features = topMarkers$gene)
```

### Top 9 Markers Expression

```{r fig.width=12,fig.asp=0.7}
ntop <- 9
for (myCluster in levels(markers$cluster)) {
  topMarkers <- markers %>% 
  filter(p_val_adj < pval & cluster == myCluster) %>%
  top_n(ntop, avg_log2FC)
  
  print(bySample.cca %>%
    FeaturePlot(features = topMarkers$gene) + NoLegend() + plot_annotation(
  title = paste("Markers for cell type:",myCluster)
))
}
```

### Top 10 Markers DotPlot

```{r fig.width=12}
ntop <- 10
pvalcut <- 0.01

topMarkers <- markers %>%
  filter(p_val_adj < pval) %>%
  group_by(cluster) %>%
  top_n(ntop, avg_log2FC) %>%
  ungroup() %>%
  dplyr::select(gene) %>%
  distinct()

DotPlot(
  bySample.cca,
  assay = "integrated",
  group.by = clustering,
  features = rev(topMarkers)
  ) +
  theme(axis.text.x = element_text(angle = 45,hjust = 1))
```

## Differences between Conditions for each Cell Type

Within each Cell Type we have tested the differences between KO and WT conditions.

```{r}
tde.files <- NULL
contrastByCond <- list()
useAssay <- "RNA"
clustering <- "CellType1"
testUse <- "wilcox"
minPct <- 0.1

cond1 <- "LSK_KO"
cond2 <- "LSK_WT"

DefaultAssay(bySample.cca) <- useAssay

bySample.cca <- bySample.cca %>%
  SetIdent(value = paste(bySample.cca$CellType1,bySample.cca$SampleName,sep="."))

deGenes <- list()
for (myCluster in levels(factor(bySample.cca$CellType1))) {
        
        ident1 <- paste(myCluster,cond1,sep=".")
        ident2 <- paste(myCluster,cond2,sep=".")
        
        deGenes[[myCluster]] <- bySample.cca %>%
          FindMarkers(
            assay = useAssay
            , slot = "data"
            , ident.1 = ident1
            , ident.2 = ident2
            , min.pct = minPct
            , test.use = testUse
            , verbose = F
          ) %>%
          mutate(gene = rownames(.),
                 cluster = myCluster)
}

Idents(bySample.cca) <- clustering
```

```{r}
pval <- 0.01

deGenes <- do.call(rbind,deGenes)

deGenes %>%
  filter(p_val_adj < pval) %>%
  group_by(cluster) %>%
  count()
```

### Top 10 Differences DotPlot

```{r fig.width=12}
ntop <- 10
pvalcut <- 0.01

topDeGenes <- deGenes %>%
  filter(p_val_adj < pval) %>%
  group_by(cluster) %>%
  top_n(ntop, avg_log2FC) %>%
  ungroup() %>%
  dplyr::select(gene) %>%
  distinct()

DotPlot(
  bySample.cca,
  assay = "RNA",
  group.by = clustering,
  features = rev(topDeGenes),
  split.by = "SampleName"
  ) +
  theme(axis.text.x = element_text(angle = 45,hjust = 1))
```

## Il1B and Il1rn Expression

```{r}
df <- Embeddings(bySample.cca,reduction = "tsne")
dnames <- colnames(df)
df <- cbind(df,bySample.cca@meta.data)
df <- cbind(df,FetchData(bySample.cca,vars = c("Il1b","Il1rn")))
```

```{r}
df %>%
  arrange(Il1b) %>%
  ggplot(aes_string(x=dnames[1],y=dnames[2])) +
  geom_point(aes_string(color="Il1b")) +
  facet_wrap("SampleName") +
  ggtitle("Il1b") +
  scale_color_gradientn(colors = colorRampPalette(c("grey","orange","red"))(3),name="Log(NormCounts)") +
  theme_classic()
```

```{r}
df %>%
  arrange(Il1rn) %>%
  ggplot(aes_string(x=dnames[1],y=dnames[2])) +
  geom_point(aes_string(color="Il1rn")) +
  facet_wrap("SampleName") +
  ggtitle("Il1rn") +
  scale_color_gradientn(colors = colorRampPalette(c("grey","orange","red"))(3),name="Log(NormCounts)") +
  theme_classic()
```

```{r fig.width=14, fig.asp=0.5}
df %>%
  mutate(Il1Exp = case_when(
    Il1b>0 & Il1rn == 0 ~ "Il1b only",
    Il1b==0 & Il1rn > 0 ~ "Il1rn only",
    Il1b>0 & Il1rn > 0 ~ "Il1b and Il1rn")) %>%
 ggplot(aes(x="",fill=Il1Exp)) +
  geom_bar(stat="count",position="fill") +
  coord_polar("y",start = 0) +
  scale_fill_manual(values = color.list) +
  facet_wrap(c("SampleName","CellType1"),ncol = 6) +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank())
```

## Violin plots on Selected Genes

```{r}
selectedGenes <- c("Ifitm1","Nmt1","Crip1","Ifitm3","Cd52","Junb","Hlf")
```

```{r}
df <- FetchData(bySample.cca,vars = selectedGenes)
df <- cbind(df,bySample.cca@meta.data)
df <- df %>% mutate(SampleName=factor(SampleName,levels = c("LSK_WT","LSK_KO")))
```

```{r}
library(stringr)
pList <- list()
for (gene in selectedGenes) {
  pList[[length(pList)+1]] <- ggplot(df,aes_string(y=gene,x="SampleName",color="SampleName",fill="SampleName")) +
    geom_violin(stat = "ydensity",alpha=0.2) +
    # geom_jitter(alpha=1) +
    scale_color_manual(values = c("grey40","#a80a0b")) +
    scale_fill_manual(values = c("grey40","#a80a0b")) +
    stat_summary(fun = "mean",
               geom = "crossbar", 
               width = 0.5,
               colour = "black") +
    ylab("Expression Level log(NormCounts+1)") +
    ggtitle(str_to_title(gene)) +
    facet_wrap("CellType1",nrow = 1) +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 90),legend.position = "none")
}

p <- lapply(pList,plot)
```

# Session Info

```{r}
sessionInfo()
```


